# Changelog
# Generated by Claude


# Version 2.1 Changes

## Issues Fixed

### 1. ✅ File Download Corruption Fixed

**Problem Identified:**
- Script was downloading ~53KB files instead of the actual ~244KB files
- Files were incomplete/corrupted and couldn't be opened
- Only getting ~22% of actual file size

**Root Cause:**
The streaming download with `iter_content()` was not properly handling the complete file download from Slack's authenticated URLs.

**Solution:**
- Changed from streaming (`stream=True`) to complete download (`response.content`)
- Added content-type validation (detects if we get HTML error page instead of file)
- Better size verification using file metadata
- Improved error logging with HTTP status codes
- Increased timeout from 30 to 60 seconds for larger files

**What Changed:**
```python
# OLD (streaming - caused truncation)
response = requests.get(url, headers=headers, stream=True, timeout=30)
for chunk in response.iter_content(chunk_size=8192):
    f.write(chunk)

# NEW (complete download - more reliable)
response = requests.get(url, headers=headers, timeout=60)
f.write(response.content)
```

### 2. ✅ Timestamped Export Folders

**New Folder Structure:**
```
Output/
├── 2025-10-22-0939/              ← New timestamped folder
│   ├── 2025-10-22-0939-Slack-Export-channelA.json
│   ├── 2025-10-22-0939-Slack-Export-channelA.txt
│   ├── 2025-10-22-0939-Slack-Export-channelA.md
│   ├── 2025-10-22-0939-Slack-Export-channelB.json
│   ├── 2025-10-22-0939-Slack-Export-channelB.txt
│   ├── 2025-10-22-0939-Slack-Export-channelB.md
│   ├── 2025-10-22-0939-anonymization-key.json
│   ├── 2025-10-22-0939-export.log    ← New log naming
│   └── attachments/
│       ├── channelA/
│       │   ├── 1234567890_file1.png
│       │   └── 1234567890_file2.pdf
│       └── channelB/
│           └── 1234567890_image.png
│
└── 2025-10-22-1430/              ← Next export run
    └── [same structure]
```

**Benefits:**
- ✅ Each export is self-contained
- ✅ Easy to find specific export runs
- ✅ No file name conflicts between exports
- ✅ Clean organization for archival
- ✅ Log file grouped with its export data

---

## Testing the Fixes

### Test File Downloads

1. **Run a fresh export** with file downloads enabled:
   ```python
   # In config.json
   "download_files": true
   ```

2. **Check the new folder structure:**
   ```powershell
   cd C:\SlackExports\Output
   ls
   # Should show: 2025-10-22-HHMM/
   
   cd 2025-10-22-HHMM
   ls
   # Should show all files + attachments folder
   ```

3. **Verify file sizes match**:
   ```powershell
   cd attachments\takserver
   Get-ChildItem | Select-Object Name, Length
   ```
   
   Compare these sizes with:
   - Open the `.json` file
   - Search for `"files"`
   - Check the `"size"` field
   - Should now MATCH! (not 53KB for a 244KB file)

4. **Try opening the files**:
   - Open any downloaded PNG/JPG in MS Photos
   - Should work now!

### Verify Download Integrity

Check the log file for new detailed messages:

```
2025-10-22 HH:MM:SS - INFO - Downloading image.png from https://files.slack.com...
2025-10-22 HH:MM:SS - INFO - Downloaded: image.png (244,040 bytes)
```

**Look for warnings:**
- `Size mismatch` = File might still be corrupted
- `Got HTML instead of file` = Authentication problem
- `HTTP error downloading` = Access denied or file deleted

### What to Watch For

**Good signs (fixed!):**
```
✅ Downloaded: image.png (244,040 bytes)
✅ File size matches expected size
✅ Files open in image viewers
```

**Problem signs (if still issues):**
```
⚠️ Size mismatch for image.png: expected 244040, got 53427 (78.1% diff)
⚠️ Got HTML instead of file - may be auth issue
⚠️ HTTP error downloading: 403
```

---

## Debugging Failed Downloads

If files still don't download correctly, check:

### 1. Check Content Type in Log

If log shows: `Got HTML instead of file` - this means Slack returned an error page instead of the file.

**Possible causes:**
- Token expired/revoked
- File was deleted after message was sent
- File requires additional permissions

### 2. Check File Metadata in JSON

Open the JSON export and find a file entry:
```json
"files": [{
  "id": "F12345",
  "name": "image.png",
  "size": 244040,
  "url_private": "https://files.slack.com/files-pri/...",
  "url_private_download": "https://files.slack.com/files-pri/.../download/..."
}]
```

Try opening `url_private` in your browser while logged into Slack. If it doesn't work there, the file is inaccessible.

### 3. Manual Test

If automated download fails, try manual download:

```python
import requests

token = "your-token"
url = "url-from-json"

headers = {"Authorization": f"Bearer {token}"}
response = requests.get(url, headers=headers)

print(f"Status: {response.status_code}")
print(f"Content-Type: {response.headers.get('content-type')}")
print(f"Size: {len(response.content)}")

with open("manual_test.png", "wb") as f:
    f.write(response.content)
```

---

## Comparing Old vs New Downloads

You have both versions in your takserver folder!

```powershell
cd C:\SlackExports\Output\attachments\takserver

# OLD (corrupted, 53KB)
Get-ItemProperty "1761071387_843449_image.png"

# NEW (manual download, 244KB)
Get-ItemProperty "image.png"
```

After running the updated script, the automatic download should match your manual download size!

---

## Migration Notes

**No breaking changes!** The new version is fully compatible.

**What stays the same:**
- File naming convention
- JSON/TXT/MD format
- Anonymization system
- Config.json structure
- Token/authentication

**What's new:**
- Exports go into timestamped folders
- Better file download reliability
- More detailed download logging
- Content-type validation

**If you prefer the old flat structure:**
You can set `OUTPUT_DIR` to include the timestamp:
```json
{
  "output_dir": "C:\\SlackExports\\Output\\2025-10-22"
}
```

But the new folder-per-export approach is cleaner for multiple exports!

---

## Next Run Checklist

Before your next export:

- [ ] Update to new `slack_channel_export_tool.py`
- [ ] Ensure `requests` library installed: `pip install requests`
- [ ] Set `download_files: true` in config.json
- [ ] Run export on a channel with images
- [ ] Check new timestamped folder created
- [ ] Verify image file sizes match JSON metadata
- [ ] Try opening downloaded images in MS Photos
- [ ] Review log file for any warnings

---

## Questions?

**Q: Will old exports still work?**  
A: Yes! Old exports in `C:\SlackExports\Output\` stay as-is. New exports go into timestamped subfolders.

**Q: Can I move old exports into timestamped folders?**  
A: Yes! Just create a folder like `2025-10-21-1200` and move the files into it. Update the paths in the anonymization key if needed.

**Q: What if I want everything in one folder?**  
A: The script now creates subfolders by default. If you really want flat structure, you'd need to modify the OUTPUT_DIR logic. But the organized approach is much better for multiple exports!

**Q: File downloads still failing?**  
A: Check the log file for specific error messages. Common issues:
- Files deleted from Slack (can't be recovered)
- URLs expired (>90 days old on free workspaces)
- Token needs to be refreshed
- Network/firewall blocking downloads

Share the relevant log excerpt and I can help debug further!





## [2.0.0] - 2025-01-15

### Added
- **Logging System**: Optional detailed logging to file with `ENABLE_LOGGING` setting
- **File Downloads**: Proper file attachment downloads using `requests` library
- **Markdown Export**: Optional `.md` formatted output with `CREATE_MARKDOWN` setting
- **Alphabetical Sorting**: Channels now display in alphabetical order
- **Smart File Skipping**: No longer creates empty files for channels with no messages in date range
- **Timestamp in Filenames**: Files now include time in YYYY-MM-DD-HHMM format
- **@ Symbol in Mentions**: User mentions now show as `[@anon01]` instead of `[anon01]`
- **Export Statistics**: Shows channels exported, total messages, and time elapsed
- **Pause at End**: Script waits for Enter key before closing (Windows convenience)
- **Better Error Handling**: Comprehensive logging of errors with stack traces
- **Progress Indicators**: Shows download progress and file counts
- **7-Day Filter Option**: Added 7-day option to date range filters

### Changed
- **Removed "TAK_USERS" from filenames**: Now uses generic "Slack-Export" naming
- **Improved User Mentions**: Better formatting in both text and markdown outputs
- **Enhanced Thread Display**: Better indentation and formatting for threaded conversations
- **File Download Method**: Switched from `urllib` to `requests` for better reliability
- **Anonymization**: More consistent handling of user IDs and mentions

### Fixed
- **File Download Issues**: Properly authenticates and downloads attachments
- **Rate Limiting**: Better handling of Slack API rate limits with exponential backoff
- **Empty Channel Handling**: No longer creates files for channels with no messages
- **Unicode Handling**: Improved support for non-ASCII characters in messages

## [1.0.0] - 2025-01-XX (Original Version)

### Added
- Basic channel export functionality
- JSON and TXT output formats
- User anonymization with mapping key
- Date range filtering (30, 60, 90 days, or all)
- Thread support
- Reaction support
- Interactive channel selection
- Multiple channel export support

---

## Planned Features (Future Releases)

### [2.1.0] - Planned
- [ ] Configuration file support (JSON/YAML)
- [ ] Progress bars with `tqdm`
- [ ] Export to SQLite database
- [ ] Incremental exports (only new messages)
- [ ] Better HTML report generation

### [3.0.0] - Planned
- [ ] Web-based UI (Flask/Streamlit)
- [ ] Search functionality across exports
- [ ] Export scheduling/automation
- [ ] Multiple workspace support
- [ ] Export encryption option
- [ ] Slack Enterprise Grid support

---

## Version History

| Version | Date | Description |
|---------|------|-------------|
| 2.0.0 | 2025-01-15 | Major rewrite with logging, file downloads, markdown export |
| 1.0.0 | 2025-01-XX | Initial release with basic export functionality |

---

## Migration Guide

### Upgrading from 1.0.0 to 2.0.0

**Breaking Changes:**
- Filename format changed from `YYYY-MM-DD-Slack-TAK_USERS-[channel]` to `YYYY-MM-DD-HHMM-Slack-Export-[channel]`
- File downloads now require `requests` library: `pip install requests`

**New Requirements:**
```bash
pip install --upgrade slack-sdk requests
```

**Configuration Changes:**
```python
# New settings to configure:
ENABLE_LOGGING = True      # Enable detailed logging
DOWNLOAD_FILES = False     # Enable file downloads
CREATE_MARKDOWN = False    # Enable markdown export
```

**What Stays the Same:**
- Token configuration
- Channel selection process
- Output directory structure
- Anonymization key format
- JSON structure

---

## Contributing

See [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines on:
- Reporting bugs
- Suggesting features
- Submitting pull requests
- Code style guidelines

## Support

- **Issues**: https://github.com/mighkel/SLACK-BAK/issues
- **Discussions**: https://github.com/mighkel/SLACK-BAK/discussions
- **Email**: [Your contact info if you want to provide it]
